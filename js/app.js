"use strict";angular.module("myApp",["myApp.config","myApp.controllers","myApp.decorators","myApp.directives","myApp.filters","myApp.routes","myApp.services"]).run(["simpleLogin",function(simpleLogin){console.log("run"),simpleLogin.getUser()}]),angular.module("changeEmail",["firebase.utils"]).factory("changeEmail",["fbutil","$q",function(fbutil,$q){return function(password,oldEmail,newEmail,simpleLogin){function authOldAccount(){return simpleLogin.login(ctx.old.email,password).then(function(user){ctx.old.uid=user.uid})}function loadOldProfile(){var def=$q.defer();return ctx.old.ref=fbutil.ref("users",ctx.old.uid),ctx.old.ref.once("value",function(snap){var dat=snap.val();null===dat?def.reject(oldEmail+" not found"):(ctx.old.name=dat.name,def.resolve())},function(err){def.reject(err)}),def.promise}function createNewAccount(){return simpleLogin.createAccount(ctx.curr.email,password,ctx.old.name).then(function(user){ctx.curr.uid=user.uid})}function copyProfile(){var d=$q.defer();ctx.curr.ref=fbutil.ref("users",ctx.curr.uid);var profile={email:ctx.curr.email,name:ctx.old.name||""};return ctx.curr.ref.set(profile,function(err){err?d.reject(err):d.resolve()}),d.promise}function removeOldProfile(){var d=$q.defer();return ctx.old.ref.remove(function(err){err?d.reject(err):d.resolve()}),d.promise}function removeOldLogin(){var def=$q.defer();return simpleLogin.removeUser(ctx.old.email,password).then(function(){def.resolve()},function(err){def.reject(err)}),def.promise}function authNewAccount(){return simpleLogin.login(ctx.curr.email,password)}var ctx={old:{email:oldEmail},curr:{email:newEmail}};return authOldAccount().then(loadOldProfile).then(createNewAccount).then(copyProfile).then(authOldAccount).then(removeOldProfile).then(removeOldLogin).then(authNewAccount).catch(function(err){return console.error(err),$q.reject(err)})}}]),angular.module("myApp.config",[]).constant("version","0.8.2").constant("loginRedirectPath","/login").constant("FBURL","https://sizzling-heat-3748.firebaseio.com").run(["FBURL","$timeout",function(FBURL,$timeout){FBURL.match("//INSTANCE.firebaseio.com")&&(angular.element(document.body).html("<h1>Please configure app/js/config.js before running!</h1>"),$timeout(function(){angular.element(document.body).removeClass("hide")},250))}]),angular.module("myApp.controllers",["firebase.utils","simpleLogin"]).controller("HomeCtrl",["$scope","fbutil","user","FBURL",function($scope,fbutil,user,FBURL){$scope.syncedValue=fbutil.syncObject("syncedValue"),$scope.user=user,$scope.FBURL=FBURL}]).controller("ChatCtrl",["$scope","messageList",function($scope,messageList){$scope.messages=messageList,$scope.addMessage=function(newMessage){newMessage&&$scope.messages.$add({text:newMessage})}}]).controller("LoginCtrl",["$scope","simpleLogin","$location",function($scope,simpleLogin,$location){function assertValidAccountProps(){return $scope.email?$scope.pass&&$scope.confirm?$scope.createMode&&$scope.pass!==$scope.confirm&&($scope.err="Passwords do not match"):$scope.err="Please enter a password":$scope.err="Please enter an email address",!$scope.err}function errMessage(err){return angular.isObject(err)&&err.code?err.code:err+""}$scope.email=null,$scope.pass=null,$scope.confirm=null,$scope.createMode=!1,$scope.login=function(email,pass){$scope.err=null,simpleLogin.login(email,pass).then(function(){$location.path("/account")},function(err){$scope.err=errMessage(err)})},$scope.createAccount=function(){$scope.err=null,assertValidAccountProps()&&simpleLogin.createAccount($scope.email,$scope.pass).then(function(){$location.path("/account")},function(err){$scope.err=errMessage(err)})}}]).controller("AccountCtrl",["$scope","simpleLogin","fbutil","user","$location",function($scope,simpleLogin,fbutil,user,$location){function resetMessages(){$scope.err=null,$scope.msg=null,$scope.emailerr=null,$scope.emailmsg=null}var profile=fbutil.syncObject(["users",user.uid]);profile.$bindTo($scope,"profile"),$scope.logout=function(){profile.$destroy(),simpleLogin.logout(),$location.path("/login")},$scope.changePassword=function(pass,confirm,newPass){resetMessages(),pass&&confirm&&newPass?newPass!==confirm?$scope.err="New pass and confirm do not match":simpleLogin.changePassword(profile.email,pass,newPass).then(function(){$scope.msg="Password changed"},function(err){$scope.err=err}):$scope.err="Please fill in all password fields"},$scope.clear=resetMessages,$scope.changeEmail=function(pass,newEmail){resetMessages(),profile.$destroy(),simpleLogin.changeEmail(pass,newEmail).then(function(user){profile=fbutil.syncObject(["users",user.uid]),profile.$bindTo($scope,"profile"),$scope.emailmsg="Email changed"},function(err){$scope.emailerr=err})}}]),angular.module("myApp.decorators",["firebase.utils","simpleLogin"]).config(["$provide",function($provide){$provide.decorator("ngCloakDirective",["$delegate","simpleLogin",function($delegate,simpleLogin){var directive=$delegate[0],_compile=directive.compile;return directive.compile=function(element,attr){simpleLogin.getUser().then(function(){_compile.call(directive,element,attr)})},$delegate}])}]),angular.module("myApp.directives",["simpleLogin"]).directive("appVersion",["version",function(version){return function(scope,elm){elm.text(version)}}]).directive("ngShowAuth",["simpleLogin","$timeout",function(simpleLogin,$timeout){var isLoggedIn;return simpleLogin.watch(function(user){isLoggedIn=!!user}),{restrict:"A",link:function(scope,el){function update(){$timeout(function(){el.toggleClass("ng-cloak",!isLoggedIn)},0)}el.addClass("ng-cloak"),update(),simpleLogin.watch(update,scope)}}}]).directive("ngHideAuth",["simpleLogin","$timeout",function(simpleLogin,$timeout){var isLoggedIn;return simpleLogin.watch(function(user){isLoggedIn=!!user}),{restrict:"A",link:function(scope,el){function update(){el.addClass("ng-cloak"),$timeout(function(){el.toggleClass("ng-cloak",isLoggedIn!==!1)},0)}update(),simpleLogin.watch(update,scope)}}}]),angular.module("myApp.filters",[]).filter("interpolate",["version",function(version){return function(text){return String(text).replace(/\%VERSION\%/gm,version)}}]).filter("reverse",function(){return function(items){return items.slice().reverse()}}),angular.module("firebase.utils",["firebase","myApp.config"]).factory("fbutil",["$window","FBURL","$firebase",function($window,FBURL,$firebase){function pathRef(args){for(var i=0;i<args.length;i++)if(angular.isArray(args[i]))args[i]=pathRef(args[i]);else if("string"!=typeof args[i])throw new Error("Argument "+i+" to firebaseRef is not a string: "+args[i]);return args.join("/")}function firebaseRef(){var ref=new $window.Firebase(FBURL),args=Array.prototype.slice.call(arguments);return args.length&&(ref=ref.child(pathRef(args))),ref}function syncData(path,props){var ref=firebaseRef(path);return props=angular.extend({},props),angular.forEach(["limit","startAt","endAt"],function(k){if(props.hasOwnProperty(k)){var v=props[k];ref=ref[k].apply(ref,angular.isArray(v)?v:[v]),delete props[k]}}),$firebase(ref,props)}return{syncObject:function(){return syncData.apply(null,arguments).$asObject()},syncArray:function(){return syncData.apply(null,arguments).$asArray()},ref:firebaseRef}}]),angular.module("myApp.routes",["ngRoute","simpleLogin"]).constant("ROUTES",{"/home":{templateUrl:"partials/home.html",controller:"HomeCtrl",resolve:{user:["simpleLogin",function(simpleLogin){return simpleLogin.getUser()}]}},"/chat":{templateUrl:"partials/chat.html",controller:"ChatCtrl"},"/login":{templateUrl:"partials/login.html",controller:"LoginCtrl"},"/account":{templateUrl:"partials/account.html",controller:"AccountCtrl",authRequired:!0}}).config(["$routeProvider",function($routeProvider){$routeProvider.whenAuthenticated=function(path,route){route.resolve=route.resolve||{},route.resolve.user=["requireUser",function(requireUser){return requireUser()}],$routeProvider.when(path,route)}}]).config(["$routeProvider","ROUTES",function($routeProvider,ROUTES){angular.forEach(ROUTES,function(route,path){route.authRequired?$routeProvider.whenAuthenticated(path,route):$routeProvider.when(path,route)}),$routeProvider.otherwise({redirectTo:"/home"})}]).run(["$rootScope","$location","simpleLogin","ROUTES","loginRedirectPath",function($rootScope,$location,simpleLogin,ROUTES,loginRedirectPath){function check(user){!user&&authRequired($location.path())&&$location.path(loginRedirectPath)}function authRequired(path){return ROUTES.hasOwnProperty(path)&&ROUTES[path].authRequired}simpleLogin.watch(check,$rootScope),$rootScope.$on("$routeChangeError",function(e,next,prev,err){angular.isObject(err)&&err.authRequired&&$location.path(loginRedirectPath)})}]),function(){angular.module("myApp.services",[]).factory("messageList",["fbutil",function(fbutil){return fbutil.syncArray("messages",{limit:10,endAt:null})}])}(),angular.module("simpleLogin",["firebase","firebase.utils","changeEmail"]).factory("requireUser",["simpleLogin","$q",function(simpleLogin,$q){return function(){return simpleLogin.getUser().then(function(user){return user?user:$q.reject({authRequired:!0})})}}]).factory("simpleLogin",["$firebaseSimpleLogin","fbutil","createProfile","changeEmail","$q","$rootScope",function($firebaseSimpleLogin,fbutil,createProfile,changeEmail,$q,$rootScope){function statusChange(){fns.getUser().then(function(user){fns.user=user||null,angular.forEach(listeners,function(fn){fn(user||null)})})}var auth=$firebaseSimpleLogin(fbutil.ref()),listeners=[],fns={user:null,getUser:function(){return auth.$getCurrentUser()},login:function(email,pass){return auth.$login("password",{email:email,password:pass,rememberMe:!0})},logout:function(){auth.$logout()},createAccount:function(email,pass,name){return auth.$createUser(email,pass).then(function(){return fns.login(email,pass)}).then(function(user){return createProfile(user.uid,email,name).then(function(){return user})})},changePassword:function(email,oldpass,newpass){return auth.$changePassword(email,oldpass,newpass)},changeEmail:function(password,newEmail){return changeEmail(password,fns.user.email,newEmail,this)},removeUser:function(email,pass){return auth.$removeUser(email,pass)},watch:function(cb,$scope){fns.getUser().then(function(user){cb(user)}),listeners.push(cb);var unbind=function(){var i=listeners.indexOf(cb);i>-1&&listeners.splice(i,1)};return $scope&&$scope.$on("$destroy",unbind),unbind}};return $rootScope.$on("$firebaseSimpleLogin:login",statusChange),$rootScope.$on("$firebaseSimpleLogin:logout",statusChange),$rootScope.$on("$firebaseSimpleLogin:error",statusChange),statusChange(),fns}]).factory("createProfile",["fbutil","$q","$timeout",function(fbutil,$q,$timeout){return function(id,email,name){function firstPartOfEmail(email){return ucfirst(email.substr(0,email.indexOf("@"))||"")}function ucfirst(str){str+="";var f=str.charAt(0).toUpperCase();return f+str.substr(1)}var ref=fbutil.ref("users",id),def=$q.defer();return ref.set({email:email,name:name||firstPartOfEmail(email)},function(err){$timeout(function(){err?def.reject(err):def.resolve(ref)})}),def.promise}}]);